<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mini Escape Room</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#111; color:#eee; }
    /* Cover overlay */
    #cover {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(6,12,28,0.9);
      z-index: 9999;
      padding: 20px;
    }
    #cover .card {
      width: min(980px, 95%);
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border-radius: 10px;
      padding: 24px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      text-align: center;
      color: #e6f0ff;
    }
    #cover h1 { margin: 0 0 6px; font-size: 2rem; letter-spacing: 0.6px; }
    #cover h3 { margin: 0 0 12px; font-weight: 400; opacity: 0.95; }
    #cover p { margin: 10px 0; color:#cfe6ff; }
    .controls { margin-top: 14px; display:flex; gap:12px; justify-content:center; }
    .btn { padding: 10px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }
    .btn-primary { background:#1e90ff; color:#fff; box-shadow: 0 8px 18px rgba(30,144,255,0.18); }
    .btn-muted { background:#2f3640; color:#fff; }

    /* Page layout */
    .scene-wrap { display:flex; justify-content:center; padding:18px 0; }
    a-scene { width: 960px; height: 600px; border-radius:6px; overflow:hidden; }

    /* Small footer */
    footer { text-align:center; margin: 12px 0 30px; color:#9aa7bf; font-size:0.9rem; }

    /* Responsive */
    @media (max-width:1000px) {
      a-scene { width: 92vw; height: 60vh; }
    }
  </style>
</head>

<body>

  <!-- COVER -->
  <div id="cover" role="dialog" aria-labelledby="cover-title" aria-describedby="cover-desc">
    <div class="card">
      <h1 id="cover-title">Mini Escape Room</h1>
      <h3>Athanasios Balampanis</h3>

      <div id="cover-desc">
        <p><strong>Scenario</strong></p>
        <p>The player must complete activities in order to win and complete the game.</p>

        <p><strong>How to play</strong></p>
        <p>Click objects to interact. For the safe you can click the on-screen keypad or type digits on your keyboard (0â€“9). Use Enter to submit and Backspace to delete.</p>
      </div>

      <div class="controls">
        <button id="btn-start" class="btn btn-primary">Start</button>
        <button id="btn-hide" class="btn btn-muted">Hide (keep paused)</button>
      </div>

      <p style="margin-top:12px; color:#bfe1ff; font-size:0.9rem;">You can bring the cover back anytime with the "Show Cover" button below the scene or press Escape.</p>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <header style="text-align:center; padding:12px 0; color:#cfe6ff;">
    <h2 style="margin:0">Mini Escape Room â€” Scene</h2>
  </header>

  <div class="scene-wrap">
    <a-scene id="scene" embedded cursor="rayOrigin: mouse" background="color: #274156">
      <!-- LIGHTS -->
      <a-light type="ambient" intensity="0.6"></a-light>
      <a-light type="point" intensity="0.9" position="0 4 3"></a-light>

      <!-- FLOOR & WALLS -->
      <a-plane rotation="-90 0 0" width="14" height="14" color="#333"></a-plane>
      <a-plane position="0 2 -7" width="14" height="4" color="#666"></a-plane>
      <a-plane position="-7 2 0" rotation="0 90 0" width="14" height="4" color="#555"></a-plane>
      <a-plane position="7 2 0" rotation="0 -90 0" width="14" height="4" color="#555"></a-plane>
      <a-plane position="0 2 7" rotation="0 180 0" width="14" height="4" color="#555"></a-plane>

      <!-- DOOR -->
      <a-box id="door" position="0 1 -6.9" width="1" height="2" depth="0.1"
             material="color: red; emissive: red; emissiveIntensity: 0.6" door></a-box>

      <!-- MESSAGE & INVENTORY -->
      <a-text id="msg" value="Solve all puzzles to open the door." position="0 2.4 -2" align="center" width="7" color="#fff"></a-text>
      <a-text id="inventory" value="Inventory: (empty)" position="-5.5 2.6 -2" align="left" width="4" color="#fff"></a-text>

      <!-- BOOK (clue) -->
      <a-box id="book" position="-3 0.6 -3" depth="0.2" height="0.2" width="0.6" material="color:brown" book></a-box>
      <a-text value="Clue Book" position="-3 1 -3" color="#fff" width="1.5" align="center"></a-text>

      <!-- SAFE (with visible keypad) -->
      <a-box id="safe" position="3 0.9 -3" width="1.2" height="0.8" depth="0.5" material="color:#222; metalness:0.4" safe>
        <a-entity position="0 0 0.26">
          <!-- row 1 -->
          <a-box safe-button="digit:1" position="-0.36 0.22 0" width="0.22" height="0.12" depth="0.02" color="#444">
            <a-text value="1" position="0 0 0.02" align="center" color="#fff" width="0.4"></a-text>
          </a-box>
          <a-box safe-button="digit:2" position="0 0.22 0" width="0.22" height="0.12" depth="0.02" color="#444">
            <a-text value="2" position="0 0 0.02" align="center" color="#fff" width="0.4"></a-text>
          </a-box>
          <a-box safe-button="digit:3" position="0.36 0.22 0" width="0.22" height="0.12" depth="0.02" color="#444">
            <a-text value="3" position="0 0 0.02" align="center" color="#fff" width="0.4"></a-text>
          </a-box>

          <!-- row 2 -->
          <a-box safe-button="digit:4" position="-0.36 0.07 0" width="0.22" height="0.12" depth="0.02" color="#444">
            <a-text value="4" position="0 0 0.02" align="center" color="#fff" width="0.4"></a-text>
          </a-box>
          <a-box safe-button="digit:5" position="0 0.07 0" width="0.22" height="0.12" depth="0.02" color="#444">
            <a-text value="5" position="0 0 0.02" align="center" color="#fff" width="0.4"></a-text>
          </a-box>
          <a-box safe-button="digit:6" position="0.36 0.07 0" width="0.22" height="0.12" depth="0.02" color="#444">
            <a-text value="6" position="0 0 0.02" align="center" color="#fff" width="0.4"></a-text>
          </a-box>

          <!-- row 3 -->
          <a-box safe-button="digit:7" position="-0.36 -0.08 0" width="0.22" height="0.12" depth="0.02" color="#444">
            <a-text value="7" position="0 0 0.02" align="center" color="#fff" width="0.4"></a-text>
          </a-box>
          <a-box safe-button="digit:8" position="0 -0.08 0" width="0.22" height="0.12" depth="0.02" color="#444">
            <a-text value="8" position="0 0 0.02" align="center" color="#fff" width="0.4"></a-text>
          </a-box>
          <a-box safe-button="digit:9" position="0.36 -0.08 0" width="0.22" height="0.12" depth="0.02" color="#444">
            <a-text value="9" position="0 0 0.02" align="center" color="#fff" width="0.4"></a-text>
          </a-box>
        </a-entity>
      </a-box>
      <a-text value="Safe" position="3 1.6 -3" color="#fff" width="1.5" align="center"></a-text>

      <!-- SWITCH BOX -->
      <a-box id="switchbox" position="0 0.5 1.5" width="1.5" height="0.8" depth="0.8" color="#333"></a-box>
      <a-text value="Press switches in order" position="0 1.3 1.5" color="#fff" width="2.5" align="center"></a-text>

      <a-box id="switch0" position="-0.5 0.9 1.2" width="0.2" height="0.2" depth="0.2" color="#f44" switch="index:0"></a-box>
      <a-box id="switch1" position="0 0.9 1.2" width="0.2" height="0.2" depth="0.2" color="#4f4" switch="index:1"></a-box>
      <a-box id="switch2" position="0.5 0.9 1.2" width="0.2" height="0.2" depth="0.2" color="#44f" switch="index:2"></a-box>
      <a-box id="boxlid" position="0 1.05 1.92" width="0.9" height="0.05" depth="0.4" color="#5b3b1b"></a-box>

      <!-- SIMON -->
      <a-entity position="-3 0.3 2.5">
        <a-box id="simon0" position="-0.6 0 0" width="0.6" height="0.1" depth="0.6" color="#ff3333" simon="index:0"></a-box>
        <a-box id="simon1" position="0 0 0" width="0.6" height="0.1" depth="0.6" color="#33ff33" simon="index:1"></a-box>
        <a-box id="simon2" position="0.6 0 0" width="0.6" height="0.1" depth="0.6" color="#3333ff" simon="index:2"></a-box>
      </a-entity>
      <a-text value="Simon: repeat sequence" position="-3 1 2.5" color="#fff" width="2.5" align="center"></a-text>

      <!-- gold key (hidden until safe opens) -->
      <a-cylinder id="goldKey" position="3 0.3 -1" radius="0.05" height="0.3"
                  material="color: gold; emissive: yellow; emissiveIntensity: 1"
                  visible="false" pickable="name:gold-key"></a-cylinder>

      <!-- camera -->
      <a-entity position="0 1.6 4">
        <a-camera>
          <a-cursor color="yellow"></a-cursor>
        </a-camera>
      </a-entity>
    </a-scene>
  </div>

  <!-- Show cover button -->
  <div style="text-align:center; margin-top:10px;">
    <button id="btn-show" class="btn btn-muted">Show Cover</button>
  </div>

  <footer>Mini Escape Room â€” Athanasios Balampanis</footer>

  <!-- SCRIPT: game components & UI wiring -->
  <script>
    /* State manager */
    const State = {
      inventory: [],
      puzzlesSolved: { safe: false, switchbox: false, simon: false },
      addToInventory(name) {
        if (!this.inventory.includes(name)) this.inventory.push(name);
        updateInventoryText();
      },
      markSolved(puzzle) {
        this.puzzlesSolved[puzzle] = true;
        updateMessage("Solved: " + puzzle + ". " + this.solvedSummary());
      },
      solvedSummary() {
        const pairs = Object.entries(this.puzzlesSolved).map(([k,v]) => `${k}:${v? 'âœ“':'âœ—'}`);
        return pairs.join(' | ');
      }
    };

    function updateInventoryText() {
      const inv = State.inventory.length ? State.inventory.join(', ') : '(empty)';
      document.getElementById('inventory').setAttribute('value', 'Inventory: ' + inv);
    }
    function updateMessage(text) {
      document.getElementById('msg').setAttribute('value', text);
    }

    /* Door component */
    AFRAME.registerComponent('door', {
      init: function () {
        this.opened = false;
        this.el.addEventListener('click', () => {
          if (!this.opened) {
            if (Object.values(State.puzzlesSolved).every(v => v)) {
              this.el.setAttribute('animation', 'property: position; to: 0 4 -6.9; dur: 1000; easing: easeOutQuad');
              this.el.setAttribute('material', 'color: lime; emissive: lime; emissiveIntensity: 1');
              updateMessage('Door opened! You escaped ðŸŽ‰');
              this.opened = true;
            } else {
              updateMessage('The door is locked. Solve all puzzles first. ' + State.solvedSummary());
            }
          }
        });
      }
    });

    /* pickable handler (for static dynamic items) */
    AFRAME.registerComponent('pickable', {
      schema: { name: { type: 'string' } },
      init: function () {
        this.el.addEventListener('click', () => {
          const name = this.data.name || this.el.id || 'item';
          State.addToInventory(name);
          this.el.setAttribute('visible', false);
          updateMessage('Picked up: ' + name);
        });
      }
    });

    /* Book (cover hint) */
    AFRAME.registerComponent('book', {
      init: function () {
        this.el.addEventListener('click', () => {
          updateMessage('The book says: "Safe code: 314"');
        });
      }
    });

    /* Safe component - accepts keypad, keyboard, and normalizes input */
    AFRAME.registerComponent('safe', {
      init: function () {
        this.code = '314';
        this.input = '';
        this.revealed = false;
        this.el.addEventListener('click', (evt) => {
          // fallback mapping to keypad via hit point (kept for compatibility)
          if (!evt.detail || !evt.detail.intersection || !evt.detail.intersection.point) return;
          if (typeof THREE === 'undefined' || !this.el.object3D || !this.el.object3D.worldToLocal) {
            const entry = prompt('Enter safe code:');
            if (entry !== null) this.check(entry.trim());
            return;
          }
          const local = this.el.object3D.worldToLocal(new THREE.Vector3().copy(evt.detail.intersection.point));
          const lx = local.x; const ly = local.y;
          const col = Math.min(2, Math.max(0, Math.floor((lx + 0.6) / 0.4)));
          const row = Math.min(2, Math.max(0, Math.floor((0.5 - ly) / 0.25)));
          const digitMatrix = [['1','2','3'],['4','5','6'],['7','8','9']];
          const digit = digitMatrix[row] ? digitMatrix[row][col] : null;
          if (!digit) {
            const entry = prompt('Enter safe code:');
            if (entry !== null) this.check(entry.trim());
            return;
          }
          this.input += digit;
          updateMessage('Safe input: ' + this.input + ' (use keypad or type digits)');
          if (this.input.length >= this.code.length) {
            this.check(this.input);
            this.input = '';
          }
        });
      },
      check: function(entry) {
        const normalized = (entry + '').replace(/\D/g, '');
        if (normalized === this.code) {
          updateMessage('Safe opened! A key appears.');
          const key = document.getElementById('goldKey');
          if (key) { key.setAttribute('visible', true); key.setAttribute('pickable', 'name:gold-key'); }
          State.markSolved('safe');
          this.revealed = true;
        } else {
          updateMessage('Safe code wrong. Try again.');
        }
      }
    });

    /* safe-button component for visible keypad */
    AFRAME.registerComponent('safe-button', {
      schema: { digit: { type: 'string' } },
      init: function () {
        this.el.addEventListener('click', () => {
          const safeEl = document.getElementById('safe');
          const safeComp = safeEl && safeEl.components && safeEl.components['safe'];
          if (!safeComp) { updateMessage('Safe not ready.'); return; }
          this.el.setAttribute('animation', 'property: scale; to: 0.9 0.9 0.9; dur:80; dir: alternate; loop:1');
          safeComp.input = (safeComp.input || '') + this.data.digit;
          updateMessage('Safe input: ' + safeComp.input);
          if (safeComp.input.length >= (safeComp.code ? safeComp.code.length : 3)) {
            safeComp.check(safeComp.input);
            safeComp.input = '';
          }
        });
      }
    });

    /* switch components & sequence */
    AFRAME.registerComponent('switch', {
      schema: { index: { type: 'int' } },
      init: function () {
        this.el.addEventListener('click', () => {
          this.el.setAttribute('animation', 'property: scale; to: 1.2 1.2 1.2; dur: 120; dir: alternate; loop: 1');
          document.dispatchEvent(new CustomEvent('switch-pressed', { detail: { idx: this.data.index } }));
        });
      }
    });

    (function () {
      const seq = [];
      const secret = [1,0,2];
      document.addEventListener('switch-pressed', (e) => {
        seq.push(e.detail.idx);
        for (let i = 0; i < seq.length; i++) {
          if (seq[i] !== secret[i]) { updateMessage('Wrong sequence. Resetting switches.'); seq.length = 0; return; }
        }
        if (seq.length === secret.length) {
          updateMessage('Switch sequence correct! Box lid opens revealing a part of a key.');
          const lid = document.getElementById('boxlid');
          lid.setAttribute('animation', 'property: rotation; to: -90 0 0; dur: 700; easing: easeOutQuad');
          const fragment = document.createElement('a-sphere');
          fragment.setAttribute('position', '0 0.75 1.92');
          fragment.setAttribute('radius', '0.06');
          fragment.setAttribute('color', '#bbb');
          fragment.setAttribute('pickable', 'name:key-fragment');
          document.querySelector('a-scene').appendChild(fragment);
          State.markSolved('switchbox');
        } else {
          updateMessage('Switch pressed: ' + seq.join(', '));
        }
      });
    })();

    /* Simon game */
    AFRAME.registerComponent('simon', {
      schema: { index: { type: 'int' } },
      init: function () {
        if (!this.el.sceneEl.simonController) this.el.sceneEl.simonController = new SimonController(this.el.sceneEl);
        this.index = this.data.index;
        this.el.addEventListener('click', () => this.el.sceneEl.simonController.playerPress(this.index));
      }
    });

    class SimonController {
      constructor(sceneEl) {
        this.scene = sceneEl;
        this.sequence = [];
        this.player = [];
        this.level = 4;
        this.panels = [document.getElementById('simon0'), document.getElementById('simon1'), document.getElementById('simon2')];
        this.playing = false;
        this.start();
      }
      start() {
        this.sequence = []; for (let i=0;i<this.level;i++) this.sequence.push(Math.floor(Math.random()*this.panels.length));
        updateMessage('Simon sequence generated. Watch and repeat.');
        setTimeout(()=> this.playSequence(), 500);
      }
      async playSequence() {
        this.playing = true;
        for (const idx of this.sequence) { await this.flash(this.panels[idx]); await this.sleep(300); }
        this.playing = false; this.player = [];
        updateMessage('Your turn: repeat the Simon sequence by clicking panels.');
      }
      async flash(panel) {
        const orig = panel.getAttribute('material').color;
        panel.setAttribute('material', 'emissive: white; emissiveIntensity: 1.5;');
        await this.sleep(400);
        panel.setAttribute('material', 'emissive: black; emissiveIntensity: 0;');
        panel.setAttribute('material', 'color', orig);
      }
      playerPress(idx) {
        if (this.playing) return;
        this.player.push(idx);
        const p = this.panels[idx];
        p.setAttribute('animation', 'property: scale; to:1.2 1.2 1.2; dur:120; dir: alternate; loop:1');
        const pos = this.player.length - 1;
        if (this.player[pos] !== this.sequence[pos]) { updateMessage('Incorrect Simon input. Sequence restarts.'); setTimeout(()=> this.start(), 800); return; }
        if (this.player.length === this.sequence.length) {
          updateMessage('Simon solved! A mechanism clicks open elsewhere.');
          State.markSolved('simon');
          const reward = document.createElement('a-torus');
          reward.setAttribute('position', '-2 0.6 2.5');
          reward.setAttribute('radius', '0.12');
          reward.setAttribute('radius-tubular', '0.02');
          reward.setAttribute('color', '#ffcc00');
          reward.setAttribute('pickable', 'name:simon-ring');
          this.scene.appendChild(reward);
        }
      }
      sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }
    }

    /* Generic pickable delegation for dynamically created items */
    document.querySelector('a-scene').addEventListener('loaded', () => {
      document.querySelector('a-scene').addEventListener('click', (evt) => {
        const el = evt.target;
        if (el && el.hasAttribute && el.hasAttribute('pickable')) {
          const name = el.getAttribute('pickable').name || el.id || 'item';
          State.addToInventory(name);
          el.setAttribute('visible', false);
          updateMessage('Picked up: ' + name);
        }
      });
    });

    /* Keyboard input for safe */
    document.addEventListener('keydown', (e) => {
      const key = e.key;
      const safeEl = document.getElementById('safe');
      const safeComp = safeEl && safeEl.components && safeEl.components['safe'];
      if (!safeComp) return;
      if (/^[0-9]$/.test(key)) {
        safeComp.input = (safeComp.input || '') + key;
        updateMessage('Safe input: ' + safeComp.input + ' (type digits or use keypad)');
        if (safeComp.input.length >= (safeComp.code ? safeComp.code.length : 3)) {
          safeComp.check(safeComp.input);
          safeComp.input = '';
        }
        return;
      }
      if (key === 'Enter') {
        if ((safeComp.input || '').length > 0) { safeComp.check(safeComp.input); safeComp.input = ''; }
        return;
      }
      if (key === 'Backspace') {
        safeComp.input = (safeComp.input || '').slice(0, -1);
        updateMessage('Safe input: ' + (safeComp.input || '(empty)'));
        return;
      }
    });

    /* UI: cover controls */
    const cover = document.getElementById('cover');
    document.getElementById('btn-start').addEventListener('click', () => {
      cover.style.display = 'none';
      // start animations if any (if you add animation-mixer components)
      document.querySelectorAll('[animation-mixer]').forEach(el => {
        el.setAttribute('animation-mixer', Object.assign({}, el.getAttribute('animation-mixer') || {}, { timeScale: 1 }));
        if (el.components && el.components['animation-mixer'] && el.components['animation-mixer'].mixer) {
          try { el.components['animation-mixer'].mixer.timeScale = 1; } catch {}
        }
      });
    });
    document.getElementById('btn-hide').addEventListener('click', () => cover.style.display = 'none');
    document.getElementById('btn-show').addEventListener('click', () => cover.style.display = 'flex');
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') cover.style.display = 'flex'; });

    /* Initialize UI text */
    updateMessage('Find and solve all puzzles: safe, switches, Simon. Click the book for a clear hint.');
    updateInventoryText();
  </script>
</body>
</html>
