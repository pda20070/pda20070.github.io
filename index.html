```html name=index.html url=https://github.com/pda20070/pda20070.github.io/blob/388d6a584f99b5133f745295156876b006c0446e/index.html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mini Escape Room - Harder</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; }
  </style>
</head>

<body>
<a-scene>

  <!-- LIGHTS -->
  <a-light type="ambient" intensity="0.6"></a-light>
  <a-light type="point" intensity="0.9" position="0 4 3"></a-light>

  <!-- FLOOR & WALLS -->
  <a-plane rotation="-90 0 0" width="14" height="14" color="#444"></a-plane>
  <a-plane position="0 2 -7" width="14" height="4" color="#888"></a-plane>
  <a-plane position="-7 2 0" rotation="0 90 0" width="14" height="4" color="#777"></a-plane>
  <a-plane position="7 2 0" rotation="0 -90 0" width="14" height="4" color="#777"></a-plane>
  <a-plane position="0 2 7" rotation="0 180 0" width="14" height="4" color="#777"></a-plane>

  <!-- DOOR (locked until all puzzles solved) -->
  <a-box id="door"
         position="0 1 -6.9"
         width="1"
         height="2"
         depth="0.1"
         material="color: red; emissive: red; emissiveIntensity: 0.6"
         door>
  </a-box>

  <!-- MESSAGE & INVENTORY -->
  <a-text id="msg"
          value="Find and solve all puzzles to open the door. (Click objects)"
          position="0 2.4 -2"
          align="center"
          width="7"
          color="white">
  </a-text>

  <a-text id="inventory"
          value="Inventory: (empty)"
          position="-5.5 2.6 -2"
          align="left"
          width="4"
          color="white">
  </a-text>

  <!-- BOOK (clue) -->
  <a-box id="book"
         position="-3 0.6 -3"
         depth="0.2" height="0.2" width="0.6"
         material="color:brown"
         class="clickable"
         book>
  </a-box>
  <a-text value="Clue Book" position="-3 1 -3" color="#fff" width="1.5" align="center"></a-text>

  <!-- KEYPAD SAFE (enhanced with visible buttons) -->
  <a-box id="safe"
         position="3 0.9 -3"
         width="1.2" height="0.8" depth="0.5"
         material="color:#222; metalness:0.4"
         safe>
    <!-- keypad buttons mounted slightly in front of the face -->
    <a-entity position="0 0 0.26">
      <!-- row 1 -->
      <a-box safe-button="digit:1" position="-0.36 0.22 0" width="0.22" height="0.12" depth="0.02" color="#444">
        <a-text value="1" position="0 0 0.02" align="center" color="#fff" width="0.4"></a-text>
      </a-box>
      <a-box safe-button="digit:2" position="0 0.22 0" width="0.22" height="0.12" depth="0.02" color="#444">
        <a-text value="2" position="0 0 0.02" align="center" color="#fff" width="0.4"></a-text>
      </a-box>
      <a-box safe-button="digit:3" position="0.36 0.22 0" width="0.22" height="0.12" depth="0.02" color="#444">
        <a-text value="3" position="0 0 0.02" align="center" color="#fff" width="0.4"></a-text>
      </a-box>

      <!-- row 2 -->
      <a-box safe-button="digit:4" position="-0.36 0.07 0" width="0.22" height="0.12" depth="0.02" color="#444">
        <a-text value="4" position="0 0 0.02" align="center" color="#fff" width="0.4"></a-text>
      </a-box>
      <a-box safe-button="digit:5" position="0 0.07 0" width="0.22" height="0.12" depth="0.02" color="#444">
        <a-text value="5" position="0 0 0.02" align="center" color="#fff" width="0.4"></a-text>
      </a-box>
      <a-box safe-button="digit:6" position="0.36 0.07 0" width="0.22" height="0.12" depth="0.02" color="#444">
        <a-text value="6" position="0 0 0.02" align="center" color="#fff" width="0.4"></a-text>
      </a-box>

      <!-- row 3 -->
      <a-box safe-button="digit:7" position="-0.36 -0.08 0" width="0.22" height="0.12" depth="0.02" color="#444">
        <a-text value="7" position="0 0 0.02" align="center" color="#fff" width="0.4"></a-text>
      </a-box>
      <a-box safe-button="digit:8" position="0 -0.08 0" width="0.22" height="0.12" depth="0.02" color="#444">
        <a-text value="8" position="0 0 0.02" align="center" color="#fff" width="0.4"></a-text>
      </a-box>
      <a-box safe-button="digit:9" position="0.36 -0.08 0" width="0.22" height="0.12" depth="0.02" color="#444">
        <a-text value="9" position="0 0 0.02" align="center" color="#fff" width="0.4"></a-text>
      </a-box>
    </a-entity>
  </a-box>
  <a-text value="Safe" position="3 1.6 -3" color="#fff" width="1.5" align="center"></a-text>

  <!-- SWITCH-SEQUENCE BOX -->
  <a-box id="switchbox"
         position="0 0.5 1.5"
         width="1.5" height="0.8" depth="0.8"
         color="#333">
  </a-box>
  <a-text value="Press switches in order" position="0 1.3 1.5" color="#fff" width="2.5" align="center"></a-text>

  <a-box id="switch0" position="-0.5 0.9 1.2" width="0.2" height="0.2" depth="0.2" color="#f44" switch="index:0"></a-box>
  <a-box id="switch1" position="0 0.9 1.2" width="0.2" height="0.2" depth="0.2" color="#4f4" switch="index:1"></a-box>
  <a-box id="switch2" position="0.5 0.9 1.2" width="0.2" height="0.2" depth="0.2" color="#44f" switch="index:2"></a-box>

  <!-- Hidden box lid (will open) -->
  <a-box id="boxlid"
         position="0 1.05 1.92"
         width="0.9" height="0.05" depth="0.4"
         color="#5b3b1b"
         visible="true">
  </a-box>

  <!-- SIMON GAME (color memory) -->
  <a-entity position="-3 0.3 2.5">
    <a-box id="simon0" position="-0.6 0 0" width="0.6" height="0.1" depth="0.6" color="#ff3333" simon="index:0"></a-box>
    <a-box id="simon1" position="0 0 0" width="0.6" height="0.1" depth="0.6" color="#33ff33" simon="index:1"></a-box>
    <a-box id="simon2" position="0.6 0 0" width="0.6" height="0.1" depth="0.6" color="#3333ff" simon="index:2"></a-box>
  </a-entity>
  <a-text value="Simon: repeat sequence" position="-3 1 2.5" color="#fff" width="2.5" align="center"></a-text>

  <!-- KEY (spawned by puzzles) - initially hidden -->
  <a-cylinder id="goldKey"
              position="3 0.3 -1"
              radius="0.05"
              height="0.3"
              material="color: gold; emissive: yellow; emissiveIntensity: 1"
              visible="false"
              pickable="name:key">
  </a-cylinder>

  <!-- CAMERA with cursor -->
  <a-camera position="0 1.6 4" wasd-controls look-controls>
    <a-cursor color="yellow"></a-cursor>
  </a-camera>

</a-scene>

<script>
/* Room state manager */
const State = {
  inventory: [],
  puzzlesSolved: { safe: false, switchbox: false, simon: false },
  addToInventory(name) {
    if (!this.inventory.includes(name)) this.inventory.push(name);
    updateInventoryText();
  },
  markSolved(puzzle) {
    this.puzzlesSolved[puzzle] = true;
    updateMessage("Solved: " + puzzle + ". " + this.solvedSummary());
    // checkAllSolved removed earlier reference; keep door logic in door component
  },
  solvedSummary() {
    const pairs = Object.entries(this.puzzlesSolved).map(([k,v]) => `${k}:${v? 'âœ“':'âœ—'}`);
    return pairs.join(' | ');
  }
};

function updateInventoryText() {
  const inv = State.inventory.length ? State.inventory.join(', ') : '(empty)';
  document.getElementById('inventory').setAttribute('value', 'Inventory: ' + inv);
}

function updateMessage(text) {
  document.getElementById('msg').setAttribute('value', text);
}

/* DOOR component: opens when all puzzles solved */
AFRAME.registerComponent('door', {
  init: function () {
    this.opened = false;
    this.el.addEventListener('click', () => {
      if (!this.opened) {
        if (Object.values(State.puzzlesSolved).every(v => v)) {
          // animate door sliding up
          this.el.setAttribute('animation', 'property: position; to: 0 4 -6.9; dur: 1000; easing: easeOutQuad');
          this.el.setAttribute('material', 'color: lime; emissive: lime; emissiveIntensity: 1');
          updateMessage('Door opened! You escaped ðŸŽ‰');
          this.opened = true;
        } else {
          updateMessage('The door is locked. Solve all puzzles first. ' + State.solvedSummary());
        }
      }
    });
  }
});

/* PICKABLE items (puts into inventory) */
AFRAME.registerComponent('pickable', {
  schema: { name: { type: 'string' } },
  init: function () {
    this.el.addEventListener('click', () => {
      const name = this.data.name || this.el.id || 'item';
      State.addToInventory(name);
      this.el.setAttribute('visible', false);
      updateMessage('Picked up: ' + name);
    });
  }
});

/* BOOK: clickable clue */
AFRAME.registerComponent('book', {
  init: function () {
    this.el.addEventListener('click', () => {
      // Gives a clue for the safe code and for Simon (first color)
      updateMessage('The book says: "Pi (3.1) hides the safe (first digits). The first Simon color is red."');
    });
  }
});

/* SAFE component: shows simple keypad UI using console-like approach and reveals key on correct code */
AFRAME.registerComponent('safe', {
  init: function () {
    this.code = '314'; // safe code (clue via book)
    this.input = '';
    this.revealed = false;
    this.el.addEventListener('click', (evt) => {
      // Backwards-compatible fallback: if user clicks the safe face (not buttons),
      // attempt to map hit point to digits (may be fiddly in some browsers)
      if (!evt.detail || !evt.detail.intersection || !evt.detail.intersection.point) {
        // nothing to do
        return;
      }
      const clickWorld = evt.detail.intersection.point;
      if (typeof THREE === 'undefined' || !this.el.object3D || !this.el.object3D.worldToLocal) {
        // can't map reliably; prompt for code instead
        const entryPrompt = prompt('Enter 3-digit safe code: (hint in book)');
        if (entryPrompt !== null) this.check(entryPrompt.trim());
        return;
      }
      const local = this.el.object3D.worldToLocal(new THREE.Vector3().copy(clickWorld));
      const lx = local.x; const ly = local.y;
      const col = Math.min(2, Math.max(0, Math.floor((lx + 0.6) / 0.4))); // 0..2
      const row = Math.min(2, Math.max(0, Math.floor((0.5 - ly) / 0.25))); // 0..2
      const digitMatrix = [
        ['1','2','3'],
        ['4','5','6'],
        ['7','8','9']
      ];
      const digit = digitMatrix[row] ? digitMatrix[row][col] : null;
      if (!digit) {
        const entry = prompt('Enter 3-digit safe code: (hint in book)');
        if (entry !== null) this.check(entry.trim());
        return;
      }
      this.input += digit;
      updateMessage('Safe input: ' + this.input + ' (use keypad for reliable input)');
      if (this.input.length >= this.code.length) {
        this.check(this.input);
        this.input = '';
      }
    });
  },
  check: function(entry) {
    if (entry === this.code) {
      updateMessage('Safe opened! A key appears.');
      // reveal the goldKey entity
      const key = document.getElementById('goldKey');
      if (key) {
        key.setAttribute('visible', true);
        key.setAttribute('pickable', 'name:gold-key');
      }
      State.markSolved('safe');
      this.revealed = true;
    } else {
      updateMessage('Safe code wrong. Try again.');
    }
  }
});

/* SAFE-BUTTON: attaches to visible keypad buttons and forwards digits to safe component */
AFRAME.registerComponent('safe-button', {
  schema: { digit: { type: 'string' } },
  init: function () {
    this.el.addEventListener('click', (evt) => {
      const safeEl = document.getElementById('safe');
      if (!safeEl) {
        console.warn('safe element not found');
        updateMessage('Safe not found.');
        return;
      }
      const safeComp = safeEl.components && safeEl.components['safe'];
      if (!safeComp) {
        console.warn('safe component not ready yet');
        updateMessage('Safe not ready yet.');
        return;
      }
      // add brief press animation
      this.el.setAttribute('animation', 'property: scale; to: 0.9 0.9 0.9; dur:80; dir: alternate; loop:1');
      safeComp.input = (safeComp.input || '') + this.data.digit;
      updateMessage('Safe input: ' + safeComp.input);
      if (safeComp.input.length >= (safeComp.code ? safeComp.code.length : 3)) {
        safeComp.check(safeComp.input);
        safeComp.input = '';
      }
    });
  }
});

/* SWITCH sequence: user must press switches in the correct order to open box lid and reveal something */
AFRAME.registerComponent('switch', {
  schema: { index: { type: 'int' } },
  init: function () {
    this.el.addEventListener('click', () => {
      // Visual click pop
      this.el.setAttribute('animation', 'property: scale; to: 1.2 1.2 1.2; dur: 120; dir: alternate; loop: 1');
      document.dispatchEvent(new CustomEvent('switch-pressed', { detail: { idx: this.data.index } }));
    });
  }
});

/* Simple global to accumulate switch presses and check order */
(function () {
  const seq = [];
  const secret = [1,0,2]; // indexes that must be pressed in order
  document.addEventListener('switch-pressed', (e) => {
    seq.push(e.detail.idx);
    // check progress: seq must match prefix of secret
    for (let i = 0; i < seq.length; i++) {
      if (seq[i] !== secret[i]) {
        updateMessage('Wrong sequence. Resetting switches.');
        seq.length = 0;
        return;
      }
    }
    if (seq.length === secret.length) {
      updateMessage('Switch sequence correct! Box lid opens revealing a part of a key.');
      // animate lid opening
      const lid = document.getElementById('boxlid');
      lid.setAttribute('animation', 'property: rotation; to: -90 0 0; dur: 700; easing: easeOutQuad');
      // reveal a small metal piece (spawn small key fragment / pickable)
      const fragment = document.createElement('a-sphere');
      fragment.setAttribute('position', '0 0.75 1.92');
      fragment.setAttribute('radius', '0.06');
      fragment.setAttribute('color', '#bbb');
      fragment.setAttribute('pickable', 'name:key-fragment');
      document.querySelector('a-scene').appendChild(fragment);
      State.markSolved('switchbox');
    } else {
      updateMessage('Switch pressed: ' + seq.join(', '));
    }
  });
})();

/* SIMON game: memory sequence using color panels */
AFRAME.registerComponent('simon', {
  schema: { index: { type: 'int' } },
  init: function () {
    if (!this.el.sceneEl.simonController) {
      this.el.sceneEl.simonController = new SimonController(this.el.sceneEl);
    }
    this.index = this.data.index;
    this.el.addEventListener('click', () => {
      this.el.sceneEl.simonController.playerPress(this.index);
    });
  }
});

class SimonController {
  constructor(sceneEl) {
    this.scene = sceneEl;
    this.sequence = [];
    this.player = [];
    this.level = 4; // length of sequence to win
    this.panels = [
      document.getElementById('simon0'),
      document.getElementById('simon1'),
      document.getElementById('simon2')
    ];
    this.playing = false;
    this.start();
  }
  start() {
    this.sequence = [];
    for (let i=0;i<this.level;i++) this.sequence.push(Math.floor(Math.random()*this.panels.length));
    updateMessage('Simon sequence generated. Watch and repeat.');
    setTimeout(()=> this.playSequence(), 500);
  }
  async playSequence() {
    this.playing = true;
    for (const idx of this.sequence) {
      await this.flash(this.panels[idx]);
      await this.sleep(300);
    }
    this.playing = false;
    this.player = [];
    updateMessage('Your turn: repeat the Simon sequence by clicking panels.');
  }
  async flash(panel) {
    const orig = panel.getAttribute('material').color;
    panel.setAttribute('material', 'emissive: white; emissiveIntensity: 1.5;');
    await this.sleep(400);
    panel.setAttribute('material', 'emissive: black; emissiveIntensity: 0;');
    // restore color
    panel.setAttribute('material', 'color', orig);
  }
  playerPress(idx) {
    if (this.playing) return;
    this.player.push(idx);
    // visual feedback
    const p = this.panels[idx];
    p.setAttribute('animation', 'property: scale; to:1.2 1.2 1.2; dur:120; dir: alternate; loop:1');
    // check correctness so far
    const pos = this.player.length - 1;
    if (this.player[pos] !== this.sequence[pos]) {
      updateMessage('Incorrect Simon input. Sequence restarts.');
      setTimeout(()=> this.start(), 800);
      return;
    }
    if (this.player.length === this.sequence.length) {
      updateMessage('Simon solved! A mechanism clicks open elsewhere.');
      State.markSolved('simon');
      // as reward, reveal another small key piece which when picked may be decorative
      const reward = document.createElement('a-torus');
      reward.setAttribute('position', '-2 0.6 2.5');
      reward.setAttribute('radius', '0.12');
      reward.setAttribute('radius-tubular', '0.02');
      reward.setAttribute('color', '#ffcc00');
      reward.setAttribute('pickable', 'name:simon-ring');
      this.scene.appendChild(reward);
    }
  }
  sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }
}

/* Attach generic pickable handler to scene so that dynamically added objects and static pickables work */
document.querySelector('a-scene').addEventListener('loaded', () => {
  document.querySelector('a-scene').addEventListener('click', (evt) => {
    const el = evt.target;
    if (el && el.hasAttribute && el.hasAttribute('pickable')) {
      const name = el.getAttribute('pickable').name || el.id || 'item';
      State.addToInventory(name);
      el.setAttribute('visible', false);
      updateMessage('Picked up: ' + name);
    }
  });
});

/* initialize message & inventory */
updateMessage('Find and solve all puzzles: safe, switches, Simon. Look for clues (e.g. the book).');
updateInventoryText();
</script>

</body>
</html>
```
